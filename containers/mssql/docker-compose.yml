# SQL Server Dev Container (HHS_HCC_SQL_container)
# ----------------------------------------------------------------------------
# HOW TO START
# - Foreground (attached logs):
#     podman compose -f containers/mssql/docker-compose.yml up
# - Detached (background):
#     podman compose -f containers/mssql/docker-compose.yml up -d
#
# HOW TO STOP
# - Keep data volume:  podman compose -f containers/mssql/docker-compose.yml down
# - Destroy data too:  podman compose -f containers/mssql/docker-compose.yml down -v
#
# INIT SQL (FIRST RUN ONLY)
# - The mssql-init service waits for SQL Server, then creates DB (MSSQL_DB)
#   and runs repo scripts via sqlcmd.
# - On subsequent starts, it detects the DB already exists and exits.
#
services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: hhs_hcc_mssql
    env_file:
      - ../../.env
    ports:
      - "1433:1433"
    volumes:
      - mssqldata:/var/opt/mssql
    healthcheck:
      test:
        - CMD-SHELL
        - /bin/bash -lc '/opt/mssql-tools18/bin/sqlcmd -S 127.0.0.1,1433 -U sa -P "$$MSSQL_SA_PASSWORD" -C -b -Q "SELECT 1" >/dev/null'
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  mssql-init:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: hhs_hcc_mssql_init
    entrypoint:
      - /bin/bash
      - -c
      - |
          set -eu
          set -o pipefail

          if [[ -z "$${MSSQL_SA_PASSWORD:-}" ]]; then
            echo "MSSQL_SA_PASSWORD is not set. Set it in .env." >&2
            exit 1
          fi

          DB_NAME="$${MSSQL_DB:-edge}"
          SQL_HOST="mssql"
          SQL_PORT="1433"

          sqlcmd_base=(
            /opt/mssql-tools18/bin/sqlcmd
            -S "$${SQL_HOST},$${SQL_PORT}"
            -U sa
            -P "$${MSSQL_SA_PASSWORD}"
            -C
            -b
          )

          echo "Waiting for SQL Server to accept logins..."
          for _ in {1..90}; do
            if "$${sqlcmd_base[@]}" -d master -Q "SELECT 1" >/dev/null 2>&1; then
              break
            fi
            sleep 2
          done

          if ! "$${sqlcmd_base[@]}" -d master -Q "SELECT 1" >/dev/null 2>&1; then
            echo "SQL Server did not become ready in time." >&2
            exit 1
          fi

          db_exists=$("$${sqlcmd_base[@]}" -d master -h -1 -W -Q "SET NOCOUNT ON; SELECT CASE WHEN DB_ID(N'$${DB_NAME}') IS NULL THEN 0 ELSE 1 END")

          if [[ "$${db_exists}" == "1" ]]; then
            sentinel_exists=$("$${sqlcmd_base[@]}" -d "$${DB_NAME}" -h -1 -W -Q "SET NOCOUNT ON; SELECT CASE WHEN OBJECT_ID(N'dbo.Enrollment', N'U') IS NULL THEN 0 ELSE 1 END" 2>/dev/null || echo 0)
            if [[ "$${sentinel_exists}" == "1" ]]; then
              echo "Database '$${DB_NAME}' already initialized (dbo.Enrollment exists)."
              echo "Init complete (no-op bootstrap)."
              exit 0
            fi
            echo "Database '$${DB_NAME}' exists but schema is missing; running bootstrap."
          fi

          echo "Running bootstrap: /init/bootstrap.sql (DB=$${DB_NAME})"
          "$${sqlcmd_base[@]}" -d master -v DB_NAME="$${DB_NAME}" -i /init/bootstrap.sql

          echo "Init complete. Next: load Enrollment/MedicalClaims/PharmacyClaims/Supplemental, then run DIY-Model-Script/DIY Model Script.sql"
    depends_on:
      mssql:
        condition: service_healthy
    env_file:
      - ../../.env
    volumes:
      - ../../:/workspace:ro,z
      - ./init:/init:ro,z
    restart: "no"

volumes:
  mssqldata:
